# Zirconium Interpreter
# Developed by Razetime
# Original spec by RocketRace

# Short spec for development purposes:
# N â† number of occupying drones
# K â† number of attached stations
#  âŒ¾ Default Stations:
#    âˆ˜ . â† single drone to each
#    âˆ˜ o â† N drones to each
#    âˆ˜ 0 â† zero drones to each
#    âˆ˜ O â† (âŒŠNÃ·K) drones to each
#    âˆ˜ Q â† N-1 drones to each
#    âˆ˜ @ â† N=0 drones to each
#  âŒ¾ Exclusion Zone Stations('{', '~', '}'):
#    âˆ˜ ? â† Input a codepoint A, dispatch A drones to all
#    âˆ˜ ! â† If N>0, end program
#    âˆ˜ % â† If N>0, print @+256|N
#    âˆ˜ & â† If N>0, print @+256|N (STDERR)
#    âˆ˜ ` â† If N>0, print N
#    âˆ˜ _ â† If N>0, dispatch â€¢BQNâ€¢GetLine@ drones to all
#    âˆ˜ ; â† Pause program for N milliseconds
#  âŒ¾ Synthetic Stations('[', '=', ']' and `(())`)
#    Simplistic stack based language with N and K as args.
#    Syntax: <char> = <stack ops>

# Helpers:
Split â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢
TwoD â† /â—‹â¥ŠâŸœâ†•âŸœâ‰¢ # 2D version of monadic /
_while_ â† {ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}
Diff â† Â¬âˆ˜âˆŠ/âŠ£
Inter â† âˆŠ/âŠ£

# Hello World program for test
test â†"    ======================================
@>@[H>d.>l>l>l...>,>_>r.....>l...>r>l>d>_.]
    ======================================
    | |  | | |    | | |      |    | | | |
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   {% %  % % %    % % %      %    % % % %}
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
((H=1N0=-72*)) ((d=1N0=-100*)) ((l=1N0=-108*))
((,=1N0=-44*)) ((r=1N0=-114*)) ((_=1N0=-32*))"




grid â† >{(âŒˆÂ´â‰ Â¨ğ•©)â†‘Â¨ğ•©}(@+10) Split test # program grid. This will be modified later

# Values for the Program Graph
names â† âŸ¨âŸ©
dCounts â† âŸ¨âŸ©
nVals â† âŸ¨âŸ©
kVals â† âŸ¨âŸ©
funcVals â† âŸ¨âŸ©
stdout â† ""
stderr â† ""

# Pure stations:
defSt â† ".o0OQ@"
defFns â† âŸ¨0>ËœâŠ£, âŠ£, 0âŠ¸âŠ£, âŒŠâˆ˜Ã·, 1-ËœâŠ£, 0=âŠ£âŸ©

# Zone detection via flood fill
# pad inds with zeroes on all sides
â€¢Show
dels â† âŸ¨0â€¿Â¯1, 1â€¿0, 0â€¿1âŸ©

# Zones:
FindZones â† {
  ğ•Š chars: #border chars.
  chs â† 2â†‘ chars
  inds â† TwoD {Â¯1â€¿Â¯1âŒ½(2+â‰¢ğ•©)â†‘ğ•©}{<(Â¬âŠ‘chsâˆŠËœâŠ‘ğ•©)âˆ§2â‰¤+Â´chsâˆŠËœ0â€¿1â€¿3âŠğ•©}âˆ˜â¥Šâ‰2 3â€¿3 â†• grid
  zones â† âŸ¨âŸ© # Holds all zone points.
  {
    zone â† âŸ¨âŸ©
    corner â† âŠ‘ğ•©
    {
      zone âˆ¾â†© ğ•©
      new â† â·âˆ¾{dels +<ğ•©}Â¨ğ•©
      ("Invalid station with top left corner"âˆ¾â—‹<corner)!Â¬âˆ¨Â´âˆ¨Â´Â¨(<â‰¢ grid)= new
      new /Ëœâ†© Â¬chars âˆŠËœ new âŠ‘Â¨< grid
      new Diff zone
    } _while_ { 0â‰ â‰ ğ•© } âŸ¨cornerâŸ©
    zones âˆ¾â†© âŸ¨zoneâŸ©
    ğ•© Diff zone
  } _while_ { 0â‰ â‰ ğ•© } inds
  zones
}
exPtsâ€¿metPts â† FindZonesÂ¨ âŸ¨"~{}", "=[]"âŸ©
# â€¢Show zoneCats

# Exclusion zones:
exSt â† "?!%&`_;"
exFns â† âŸ¨{ğ•¨ğ•Šğ•©:@-ËœâŠ‘â€¢GetLine@}, {"Program has ended."!ğ•¨>0}, {0âŠ£stdoutâˆ¾â†©@+256|ğ•¨}, {0âŠ£stderrâˆ¾â†©@+256|ğ•¨}, {0âŠ£stdoutâˆ¾â†©â€¢Show ğ•¨}, {ğ•¨ğ•Šğ•©:â€¢BQNâ€¢GetLine@}, {0âŠ£â€¢Delay ğ•¨Ã·1000}âŸ©



# Lenses:
# (Ã—âˆ˜â‰ Â¨/âŠ¢)(âŠ¢-ËœÂ¬Ã—+`)âŠ¸âŠ”
lenses â† (1â†“Â¯1âŠ¸â†“)Â¨(Ã—âˆ˜â‰ Â¨/âŠ¢)âˆ¾(((Â¬Â·<0âˆ¾+`)Ë˜("(("âŠ¸â·-"))"âŠ¸â·)){ğ•¨(âŠ¢-ËœÂ¬Ã—+`)âŠ¸âŠ”ğ•©}Â¨<Ë˜) grid
â€¢Show lenses

StackLang â† {
  ğ•Š prg:
  stack â† âŸ¨âŸ©
  tokens â† {
    "+": +;
    "-": -;
    "*": Ã—;
    "/": Ã·;
    "=": =;
    "N": 'n';
    "K": 'k';
    â€¢BQN ğ•©    # add a descriptive error message for non-number later
  }Â¨prgâŠ”Ëœ1-Ëœ+`(prgâˆŠ"+-*/=")âˆ¨((âŠ¢âˆ§âŠ¢â‰ Â»)prgâˆŠ'0'+â†•10)âˆ¨prgâˆŠ"NK"
  { # borrowed from dzaima
    âŠ‘âŸ¨âŸ© {
      nğ•Šs: 
      â€¢Typeâ—¶âŸ¨
      !
      sâˆ¾<
      {sâˆ¾(âŠ‘"nk"âŠğ•©)âŠ‘âŠ£â€¿âŠ¢}
      {ğ•Šf: (Â¯2â†“s)âˆ¾<{ğ•Fğ•}Â´Â¯2â†‘s}
    âŸ© n}Â´âŒ½ ğ•©
  } tokens
}

# Metropoleis mapping
mtSt â† ""
reserve â† "~[]={}-+|/\"

mtFns â† {
  ("Lens Error: Invalid definition '"âˆ¾ğ•©âˆ¾"'")!('='=1âŠ‘ğ•©)âˆ§âŠ‘Â¬ reserve âˆŠËœ â‹ˆâŠ‘ğ•©
  reserve âˆ¾â†© âŠ‘ğ•©
  mtSt âˆ¾â†© âŠ‘ğ•©
  f â† StackLang 2â†“ğ•©
  f
}Â¨lenses


metSts â† (TwoD gridâˆŠmtSt) Inter âŠ‘metPts
â€¢Show grid

deltas â† âŸ¨1â€¿1,1â€¿0,1â€¿Â¯1,0â€¿1,0â€¿Â¯1,Â¯1â€¿1,Â¯1â€¿0,Â¯1â€¿Â¯1âŸ©

GetStations â† {
  ğ•Š pointsâ€¿charsâ€¿fns:
  stations â† âŸ¨âŸ©
  curr â† â‹ˆâŠ‘points
  { # get each station and put it in stations
    ğ•Šğ•©:
    cch â† currâŠ‘grid

    { # Flood fill to bind stations together.
      ngb â† (âˆ¾<Ë˜deltas+âŒœğ•©) Diff ğ•©
      ngb â†© (cch=ngbâŠgrid) / ngb
      curr âˆ¾â†© ngb
      ngb
    } _while_ { ğ•©â‰¢âŸ¨âŸ© } curr

    { # Now get the connections.
      (âˆ¾âŸœ"*[]={}~"Â¨âŸ¨"\#", "|^", "/#", "->", "-<", "/#", "|v", "\#"âŸ©){ğ•¨âˆŠËœğ•©âŠgrid}Â¨deltas+<ğ•©
    }Â¨curr
    stations âˆ¾â†© âŸ¨cch, curr, (âŠ‘cchâŠchars)âŠ‘fns, 0, 0âŸ©
    points â†© points Diff curr

    # reset curr for next iteration
    curr â†© âŠ‘points

  } _while_ { ğ•Šğ•©: points â‰¢ âŸ¨âŸ©}
}
