# Zirconium Interpreter
# Developed by Razetime
# Original spec by RocketRace

# Short spec for development purposes:
# Nâ†number of occupying drones
# Kâ†number of attached stations
#  âŒ¾ Default Stations:
#    âˆ˜ .â†single drone to each
#    âˆ˜ oâ†N drones to each
#    âˆ˜ 0â†zero drones to each
#    âˆ˜ Oâ†(âŒŠNÃ·K) drones to each
#    âˆ˜ Qâ†N-1 drones to each
#    âˆ˜ @â†N=0 drones to each
#  âŒ¾ Exclusion Zone Stations('{', '~', '}'):
#    âˆ˜ ?â†Input a codepoint A, dispatch A drones to all
#    âˆ˜ !â†If N>0, end program
#    âˆ˜ %â†If N>0, print @+256|N
#    âˆ˜ &â†If N>0, print @+256|N (STDERR)
#    âˆ˜ `â†If N>0, print N
#    âˆ˜ _â†If N>0, dispatch â€¢BQNâ€¢GetLine@ drones to all
#    âˆ˜ ;â†Pause program for N milliseconds
#  âŒ¾ Synthetic Stations('[', '=', ']' and `(())`)
#    Simplistic stack based language with N and K as args.
#    Syntax: <char> = <stack ops>

# helpers
Splitâ†(âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢
SplitSâ†((âŠ¢-ËœÂ¬Ã—Â·+`Â»âŠ¸<)âˆ˜âˆŠËœâŠ”âŠ¢)
DIâ†/â—‹â¥ŠâŸœâ†•âŸœâ‰¢ # n-D version of monadic /
_while_â†{ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}
Diffâ†Â¬âˆ˜âˆŠ/âŠ£
Interâ†âˆŠ/âŠ£
Trwâ†{ğ•©/ËœÂ¬âˆ§`âŒ¾âŒ½' '=ğ•©}
Divâ†{Â·ğ•Š0:0;âŒŠğ•¨Ã·ğ•©} # division by zero returns zero

# constants
resâ†"~[]={}-+|/\" # reserved chars

Gridâ†{>((âŒˆÂ´â‰ Â¨)â†‘Â¨âŠ¢){Trw"    "(âŠ£âˆ¾"    "âˆ¾âŠ¢)Â´'	'Splitğ•©}Â¨(@+10)Splitğ•©}

# lens interpreter
ILenâ†{
  ğ•Š prg:
  nâ†âŠ‘prg
  {âŠ‘nâˆŠres?â€¢Show "Invalid lens name '"âˆ¾nâˆ¾"' in lens (("âˆ¾prgâˆ¾"))";@}
  prgâ†©2â†“prg
  stackâ†âŸ¨âŸ©
  tokensâ†{
    "+": +; "-": -; "*": Ã—; "/": Div;
    "=": =; "N": 'n'; "K": 'k';
    âˆ§Â´((ğ•©â‰¥'0')âˆ§ğ•©â‰¤'9')?10âŠ¸Ã—âŠ¸+ËœÂ´âŒ½ğ•©-'0';
    â€¢Show"Invalid lens instruction '"âˆ¾ğ•©âˆ¾"' in '"âˆ¾prgâˆ¾"'",â€¢Exit@
  }Â¨prgâŠ”Ëœ1-Ëœ+`(prgâˆŠ"+-*/=")âˆ¨((âŠ¢âˆ§âŠ¢â‰ Â»)prgâˆŠ'0'+â†•10)âˆ¨prgâˆŠ"NK"
  # dzaima
  nâˆ¾âŠ‘âŸ¨âŸ© {
    nğ•Šs: 
    â€¢Typeâ—¶âŸ¨
    !
    sâˆ¾<
    {sâˆ¾(âŠ‘"nk"âŠğ•©)âŠ‘âŠ£â€¿âŠ¢}
    {ğ•Šf: (Â¯2â†“s)âˆ¾<{ğ•Fğ•}Â´Â¯2â†‘s}
  âŸ© n}Â´âŒ½tokens
}

# lens parser
Lensâ†{
  lâ†(âŠ¢âˆ¨0â€¿0âŠ¸Â»Ë˜)(â‰ â†‘Â·â‰ `"(("âŠ¸â·âˆ¨"))"âŠ¸â·)âŒ¾â¥Šğ•©
  (âˆ¨Â´â¥Šl)â—¶âŸ¨ğ•©,âŸ¨âŸ©âŸ©â€¿{âŸ¨' 'Â¨âŒ¾((DI l)âŠ¸âŠ‘)ğ•©,ILenÂ¨"))(("SplitS 2â†“Â¯2â†“l/â—‹â¥Šğ•©âŸ©}ğ•©
}

# zone + station finder (general)
ZnSâ†{
  âŸ¨lâ€¿tâ€¿r,s,f,exâŸ© ğ•Š g:
  
  stâ†(DI gâˆŠs) Diff ex
  {stâ‰¡âŸ¨âŸ©?â†•2â€¿0;
  ltrâ†lâ€¿tâ€¿r
    retâ†âŸ¨âŸ©
    {
      vzâ†â‹ˆâŠ‘ğ•©
      {
        vzâˆ¾â†©i_â†vz DiffËœ{
          bâ†{(ğ•©â‰¥0)âˆ§â—‹(âˆ§Â´)ğ•©<â‰¢g}Â¨ğ•©
          (b/ğ•©)/ËœâŸ¨râ€¿t,lâ€¿t,ltr,ltrâŸ©{âˆ§Â´ğ•¨â‰ ğ•©âŠ‘g}Â¨â—‹(bâŠ¸/)ğ•©
        }(âŠğ•©)+âŸ¨0â€¿1,0â€¿Â¯1,1â€¿0,Â¯1â€¿0âŸ©
        (1â†“ğ•©)âˆ¾i_
      }_while_(0<â‰ )â‹ˆâŠ‘ğ•©
      retâˆ¾â†©vz
      ğ•© Diff vz
    }_while_(0<â‰ )st
    ret(âˆŠâŸœsâŠ‘âŸœg)âŠ¸/â†©
    retâ‰fâŠËœsâŠretâŠ‘g
  }
}
,
# zone ,function data
# wâ†N, ,ğ•©â†K
eâ†"?!%&`_;"
eFâ†âŸ¨
  {ğ•¨>0?@-ËœâŸ(0âŠ¸â‰¢)â€¢term.CharB@;0}
  {ğ•¨>0?"Program has ended."!ğ•¨>0;0}
  {ğ•¨>0?â€¢term.OutRawâ‹ˆ@+256|ğ•¨,â€¢term.Flush@,0;0}
  {ğ•¨>0?â€¢term.ErrRaw@+256|ğ•¨,â€¢term.Flush@,0;0}
  {ğ•¨>0?â€¢term.OutRawâ€¢Reprğ•¨,â€¢term.Flush@,0;0}
  {ğ•¨>0?(âˆ§Â´â‰¥âŠ¸'0'âˆ§â‰¤âŸœ'9')â—¶âŸ¨
      {â€¢Show"Invalid number '"âˆ¾ğ•©âˆ¾"'",â€¢Exit@}
      10âŠ¸Ã—âŠ¸+Â´
    âŸ©â€¢GetLine@; 0
  }
  {0âŠ£â€¢Delay ğ•¨Ã·1000}
âŸ©
pâ†".o0OQ@"
pFâ†âŸ¨0<âŠ£, âŠ£, 0, Div, 1-ËœâŠ£, 0=âŠ£âŸ©
# stations grouped together
nbâ†âŸ¨1â€¿1,1â€¿0,1â€¿Â¯1,0â€¿1,0â€¿Â¯1,Â¯1â€¿1,Â¯1â€¿0,Â¯1â€¿Â¯1âŸ©
Stnâ†{
  ğ•Š a:
  stsâ†âŸ¨âŸ©
  {
    vzâ†â‹ˆâŠ‘ğ•©
    {
      vzâˆ¾â†©i_â†vz DiffËœâˆŠâŸœ(âŠa)âŠ¸/(âŠğ•©)+nb
      (1â†“ğ•©)âˆ¾i_
    }_while_(0<â‰ )â‹ˆâŠ‘ğ•©
    stsâˆ¾â†©âŸ¨vzâŸ©
    ğ•© Diff vz
  }_while_(0<â‰ )âŠa
  stsâ‰{(1âŠa)âŠËœğ•©âŠËœâŠa}Â¨sts
}

# single station connections
Connâ†{
  sâ€¿g ğ•Š p:
  # nbâ†         âŸ¨1â€¿1,  1â€¿0,  1â€¿Â¯1, 0â€¿1,  0â€¿Â¯1,Â¯1â€¿1,Â¯1â€¿0,Â¯1â€¿Â¯1âŸ©
  tâ†"*[]={}~"âŠ¸âˆ¾Â¨âŸ¨"\#", "|v", "/#", "->", "-<", "/#", "|^", "\#"âŸ©
  psâ†âŸ¨âŸ©
  {
    ğ•Š dâ€¿c:
    fâ†+âŸœd _while_{(0â€¿0â‰¤ğ•©+d)âˆ§â—‹(âˆ§Â´)(ğ•©+d)<â‰¢g?âŠ‘câˆŠËœgâŠ‘Ëœğ•©+d;0}p
    {âŠ‘câˆŠËœfâŠ‘g?psâˆ¾â†©â‹ˆd+f;@}
  }Â¨nbâ‹ˆÂ¨t
  ps Inter s
}

# connections for all stations
Acoâ†{ğ•¨âˆ¾Ëœ(</)Ë˜((âˆ¾âŸ¨âˆ¾âŠğ•¨,ğ•©âŸ©âŠ¸ConnÂ¨)Â¨âˆ¨Â´âˆ˜âˆŠâŒœâŠ¢)âŠğ•¨}

Runâ†{
  #{â€¢Show ğ•©âŠËœâ‹(âŠ‘1âŠ¸âŠ‘)Ë˜ğ•©}Â¨{
  {
    nâ†((â‰ ğ•©)â¥Š0){iâ€¿Â·â€¿fâ€¿d ğ•Š ğ•©:(+Â´f{ğ•©ğ•â‰ i}Â¨d)âŠ¸+âŒ¾(iâŠ¸âŠ)ğ•©}Ëğ•©
    nâˆ¾ËœË˜Â¯1â†“Ë˜ğ•© 
  #}âŸ(â†•4) â‰âˆ¾âŸœ(0Â¨âˆ˜âŠ)ğ•©
  }_while_ 1 â‰âˆ¾âŸœ(0Â¨âˆ˜âŠ)ğ•©
  @
}

# interpreter
Inâ†{
  ngâ€¿lâ†Lens Grid ğ•©
  lâˆ¾â†©ğ•¨
  metâ†âŸ¨"[=]",âŠ‘Â¨l,1âŠ‘Â¨l,âŸ¨âŸ©âŸ©Zns ng
  excâ†âŸ¨"{~}",e,eF,âŠmetâŸ©Zns ng
  piâ†(DI ngâˆŠp)Diff metâˆ¾â—‹âŠexc
  purâ†piâ‰pFâŠËœpâŠpiâŠ‘ng
  aâ†metâˆ¾Ë˜excâˆ¾Ë˜pur 
  Run (Stn a) Aco ng # run the parsed graph
}

{fâ€¿h:(ILenÂ¨â€¢FLines h)Inâ€¢FChars f;âŸ¨âŸ©Inâ€¢FCharsâŠ‘ğ•©}â€¢args
