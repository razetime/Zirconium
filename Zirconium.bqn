# Zirconium Interpreter
# Developed by Razetime
# Original spec by RocketRace

# Short spec for development purposes:
# Nâ†number of occupying drones
# Kâ†number of attached stations
#  âŒ¾ Default Stations:
#    âˆ˜ .â†single drone to each
#    âˆ˜ oâ†N drones to each
#    âˆ˜ 0â†zero drones to each
#    âˆ˜ Oâ†(âŒŠNÃ·K) drones to each
#    âˆ˜ Qâ†N-1 drones to each
#    âˆ˜ @â†N=0 drones to each
#  âŒ¾ Exclusion Zone Stations('{', '~', '}'):
#    âˆ˜ ?â†Input a codepoint A, dispatch A drones to all
#    âˆ˜ !â†If N>0, end program
#    âˆ˜ %â†If N>0, print @+256|N
#    âˆ˜ &â†If N>0, print @+256|N (STDERR)
#    âˆ˜ `â†If N>0, print N
#    âˆ˜ _â†If N>0, dispatch â€¢BQNâ€¢GetLine@ drones to all
#    âˆ˜ ;â†Pause program for N milliseconds
#  âŒ¾ Synthetic Stations('[', '=', ']' and `(())`)
#    Simplistic stack based language with N and K as args.
#    Syntax: <char> = <stack ops>

# helpers
Splitâ†(âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢
SplitSâ†((âŠ¢-ËœÂ¬Ã—Â·+`Â»âŠ¸<)âˆ˜âˆŠËœâŠ”âŠ¢)
DIâ†/â—‹â¥ŠâŸœâ†•âŸœâ‰¢ # n-D version of monadic /
_while_â†{ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}
Diffâ†Â¬âˆ˜âˆŠ/âŠ£
Interâ†âˆŠ/âŠ£
Trwâ†{ğ•©/ËœÂ¬âˆ§`âŒ¾âŒ½' '=ğ•©}

# constants
resâ†"~[]={}-+|/\" # reserved chars

Gridâ†{>((âŒˆÂ´â‰ Â¨)â†‘Â¨âŠ¢){Trw"    "(âŠ£âˆ¾"    "âˆ¾âŠ¢)Â´'	'Splitğ•©}Â¨(@+10)Splitğ•©}

# lens interpreter
ILenâ†{
  ğ•Š prg:
  nâ†âŠ‘prg
  {âŠ‘nâˆŠres?â€¢Show "Invalid lens name '"âˆ¾nâˆ¾"' in lens (("âˆ¾prgâˆ¾"))";@}
  prgâ†©2â†“prg
  stackâ†âŸ¨âŸ©
  tokensâ†{
    "+": +; "-": -; "*": Ã—; "/": Ã·;
    "=": =; "N": 'n'; "K": 'k';
    âˆ§Â´((ğ•©â‰¥'0')âˆ§ğ•©â‰¤'9')?10âŠ¸Ã—âŠ¸+Â´âŒ½ğ•©-'0';
    â€¢Show"Invalid lens instruction '"âˆ¾ğ•©âˆ¾"' in '"âˆ¾prgâˆ¾"'",â€¢Exit@
  }Â¨prgâŠ”Ëœ1-Ëœ+`(prgâˆŠ"+-*/=")âˆ¨((âŠ¢âˆ§âŠ¢â‰ Â»)prgâˆŠ'0'+â†•10)âˆ¨prgâˆŠ"NK"
  # dzaima
  nâˆ¾âŠ‘âŸ¨âŸ© {
    nğ•Šs: 
    â€¢Typeâ—¶âŸ¨
    !
    sâˆ¾<
    {sâˆ¾(âŠ‘"nk"âŠğ•©)âŠ‘âŠ£â€¿âŠ¢}
    {ğ•Šf: (Â¯2â†“s)âˆ¾<{ğ•Fğ•}Â´Â¯2â†‘s}
  âŸ© n}Â´âŒ½tokens
}

# lens parser
Lensâ†{
  lâ†(âŠ¢âˆ¨0â€¿0âŠ¸Â»Ë˜)(â‰ â†‘Â·â‰ `"(("âŠ¸â·âˆ¨"))"âŠ¸â·)âŒ¾â¥Šğ•©
  âŸ¨' 'Â¨âŒ¾((DI l)âŠ¸âŠ‘)ğ•©,ILenÂ¨"))(("SplitS 2â†“Â¯2â†“l/â—‹â¥Šğ•©âŸ©
}

# zone finder (general)
Zonesâ†{
  âŸ¨lâ€¿tâ€¿r,s,exâŸ© ğ•Š g:
  ltrâ†lâ€¿tâ€¿r
  retâ†âŸ¨âŸ©
  vâ†âŸ¨âŸ©
  {
    â€¢Show "vz"â‹ˆ vzâ†â‹ˆâŠ‘ğ•©
    {
      vzâˆ¾â†©i_â†vz DiffËœ{
        bâ†{(ğ•©â‰¥0)âˆ§â—‹(âˆ§Â´)ğ•©<â‰¢g}Â¨ğ•©
        â€¢Show (b/ğ•©)/ËœâŸ¨râŠ¸â‰ ,lâŠ¸â‰ ,Â¬Â·âŠ‘âˆŠâŸœltr,Â¬Â·âŠ‘âˆŠâŸœltrâŸ©{ğ•ğ•©âŠ‘g}Â¨â—‹(bâŠ¸/)ğ•©
      }(â€¢Show âŠğ•©)+âŸ¨0â€¿1,0â€¿Â¯1,1â€¿0,Â¯1â€¿0âŸ©
      (1â†“ğ•©)âˆ¾i_
    }_while_(0<â‰ )â‹ˆâŠ‘ğ•©
    retâˆ¾â†©âŸ¨vzâŸ©
    ğ•© Diff vz
  }_while_(0<â‰ )(DI â€¢Show gâˆŠs) Diff ex
  ret
}

# Values for the Program Graph
namesâ†âŸ¨âŸ©
dCountsâ†âŸ¨âŸ©
nValsâ†âŸ¨âŸ©
kValsâ†âŸ¨âŸ©
funcValsâ†âŸ¨âŸ©
stdoutâ†""
stderrâ†""

# Pure stations:
pâ†".o0OQ@"
pFâ†âŸ¨0>ËœâŠ£, âŠ£, 0âŠ¸âŠ£, âŒŠâˆ˜Ã·, 1-ËœâŠ£, 0=âŠ£âŸ©

# Exclusion zones:
eâ†"?!%&`_;"
eFâ†âŸ¨
  {ğ•¨ğ•Šğ•©:@-ËœâŠ‘â€¢GetLine@}
  {"Program has ended."!ğ•¨>0}
  {0âŠ£stdoutâˆ¾â†©@+256|ğ•¨}
  {0âŠ£stderrâˆ¾â†©@+256|ğ•¨}
  {0âŠ£stdoutâˆ¾â†©â€¢Show ğ•¨}
  {ğ•¨ğ•Šğ•©:â€¢BQNâ€¢GetLine@}
  {0âŠ£â€¢Delay ğ•¨Ã·1000}
âŸ©

deltasâ†âŸ¨1â€¿1,1â€¿0,1â€¿Â¯1,0â€¿1,0â€¿Â¯1,Â¯1â€¿1,Â¯1â€¿0,Â¯1â€¿Â¯1âŸ©

GetStationsâ†{
  ğ•Š pointsâ€¿charsâ€¿fns:
  stationsâ†âŸ¨âŸ©
  currâ†â‹ˆâŠ‘points
  { # get each station and put it in stations
    ğ•Šğ•©:
    cchâ†currâŠ‘grid

    { # Flood fill to bind stations together.
      ngbâ†(âˆ¾<Ë˜deltas+âŒœğ•©) Diff ğ•©
      ngb â†© (cch=ngbâŠgrid) / ngb
      curr âˆ¾â†© ngb
      ngb
    } _while_ { ğ•©â‰¢âŸ¨âŸ© } curr

    { # Now get the connections.
      (âˆ¾âŸœ"*[]={}~"Â¨âŸ¨"\#", "|^", "/#", "->", "-<", "/#", "|v", "\#"âŸ©){ğ•¨âˆŠËœğ•©âŠgrid}Â¨deltas+<ğ•©
    }Â¨curr
    stations âˆ¾â†© âŸ¨cch, curr, (âŠ‘cchâŠchars)âŠ‘fns, 0, 0âŸ©
     points â†© points Diff curr

    # reset curr for next iteration
    curr â†© âŠ‘points

  } _while_ { ğ•Šğ•©: points â‰¢ âŸ¨âŸ©}
}


gâ†Grid"    ======================================
@>@[H>d.>l>l>l...>,>_>r.....>l...>r>l>d>_.]
    ======================================
    | |  | | |    | | |      |    | | | |
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   {% %  % % %    % % %      %    % % % %}
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
((H=1N0=-72*)) ((d=1N0=-100*)) ((l=1N0=-108*))
((,=1N0=-44*)) ((r=1N0=-114*)) ((_=1N0=-32*))"

# testing function
Tâ†{
  ngâ€¿lâ†Lens ğ•©
  metâ†âŸ¨"[=]",âŠ‘Â¨l,âŸ¨âŸ©âŸ© Zones ng
  excâ†âŸ¨"{~}",e,âˆ¾metâŸ© Zones ng
  metâ‰â—‹<exc
}
